--use uregina

/* Supposed to be processed in auto-charge of Mar 1, 2018. (435 records) */
SELECT H.* FROM ARSCHEDULEHEADER H
WHERE 1=1
	AND SUSPEND_AUTO_PAY = 0
	AND AUTO_PAYMENT_TYPE IN (1,2,3) AND AUTO_PAYMENT_STATUS IN (0, 10, 11)
	AND ARSCHEDULEHEADER_ID IN (
		SELECT S.ARSCHEDULEHEADER_ID
		FROM (
				SELECT ARSCHEDULEHEADER_ID, SUM(AMOUNTDUE) AMOUNT_SCHEDULED FROM ARSCHEDULEDETAIL
				WHERE ARSCHEDULEHEADER_ID IN (SELECT DISTINCT ARSCHEDULEHEADER_ID FROM ARSCHEDULEDETAIL WHERE DATEDUE = '20180301')
					AND DATEDUE <= '20180301'
				GROUP BY ARSCHEDULEHEADER_ID
			) AS S
			INNER JOIN (
				SELECT ARSCHEDULEHEADER_ID, SUM(AMOUNTDUE) AMOUNT_TOTAL FROM ARSCHEDULEDETAIL
				WHERE ARSCHEDULEHEADER_ID IN (SELECT DISTINCT ARSCHEDULEHEADER_ID FROM ARSCHEDULEDETAIL WHERE DATEDUE = '20180301')
				GROUP BY ARSCHEDULEHEADER_ID
			) AS STotal ON S.ARSCHEDULEHEADER_ID = STotal.ARSCHEDULEHEADER_ID
			LEFT JOIN (
				SELECT ARSCHEDULEHEADER_ID, SUM(AMOUNT) AS AMOUNT_DUE FROM ARTRANSACTIONS
				WHERE ARSCHEDULEHEADER_ID IN (SELECT DISTINCT ARSCHEDULEHEADER_ID FROM ARSCHEDULEDETAIL WHERE DATEDUE = '20180301')
					AND DATESTAMP < '20180301'
				GROUP BY ARSCHEDULEHEADER_ID
			) AS T ON S.ARSCHEDULEHEADER_ID = T.ARSCHEDULEHEADER_ID
		WHERE S.AMOUNT_SCHEDULED > STotal.AMOUNT_TOTAL - ISNULL(T.AMOUNT_DUE, 0) -- STotal.AMOUNT_TOTAL - ISNULL(T.AMOUNT_DUE, 0) is the amount paid by Mar 1.
	)
ORDER BY H.ARSCHEDULEHEADER_ID

/* Actually processed in auto-charge of Mar 1, 2018. (382 records) */
SELECT DISTINCT ARSCHEDULEHEADER_ID FROM ARTRANSACTIONS WHERE DATESTAMP BETWEEN '20180301' AND '20180301 4:00' ORDER BY ARSCHEDULEHEADER_ID

/* Un-processed on time. (599 records) */
select c.CUSTOMER_ID, c.FIRSTNAME, c.LASTNAME, h.RECEIPTNUMBER, h.RECEIPTHEADER_ID, ah.*
from DBO.ARSCHEDULEHEADER ah
	inner join DBO.RECEIPTPAYMENTS rp on ah.receiptpayment_id = rp.receiptpayment_id
	inner join RECEIPTHEADERS h on h.RECEIPTHEADER_ID = rp.RECEIPTHEADER_ID
	inner join customers c on ah.customer_id = c.customer_id
where ah.ARSCHEDULEHEADER_ID in ((8217), (9271), (9350), (9621), (9736), (9840), (9993), (10004), (10046), (10116), (10117), (10118), (10119), (10240), (11013), (11014), (11073), (11259), (11400), (11416), (11534), (11586), (11587), (11589), (11590), (11599), (11703), (11722), (11723), (11724), (11744), (11776), (11777), (11789), (11857), (11860), (11872), (11880), (11918), (11967), (11991), (11993), (12020), (12051), (12063), (12091), (12137), (12138), (12175), (12198), (12230), (12233), (12244))
order by c.CUSTOMER_ID, ah.ARSCHEDULEHEADER_ID
