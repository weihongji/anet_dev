--use uregina
SELECT c.CUSTOMER_ID, c.FIRSTNAME, c.LASTNAME, h.RECEIPTNUMBER, h.RECEIPTHEADER_ID, ah.*
FROM ARSCHEDULEHEADER ah
	inner join DBO.RECEIPTPAYMENTS rp on ah.receiptpayment_id = rp.receiptpayment_id
	inner join RECEIPTHEADERS h on h.RECEIPTHEADER_ID = rp.RECEIPTHEADER_ID
	inner join customers c on ah.customer_id = c.customer_id
WHERE 1=1
	AND SUSPEND_AUTO_PAY = 0
	AND AUTO_PAYMENT_TYPE IN (1,2,3) AND AUTO_PAYMENT_STATUS IN (0, 10, 11)
	AND ARSCHEDULEHEADER_ID IN (
		SELECT S.ARSCHEDULEHEADER_ID
		FROM (
				SELECT ARSCHEDULEHEADER_ID, SUM(AMOUNTDUE) AMOUNT_FUTURE FROM ARSCHEDULEDETAIL
				WHERE ARSCHEDULEHEADER_ID IN (SELECT DISTINCT ARSCHEDULEHEADER_ID FROM ARSCHEDULEDETAIL WHERE DATEDUE = '20180301')
					AND DATEDUE > '20180301'
				GROUP BY ARSCHEDULEHEADER_ID
			) AS S
			LEFT JOIN (
				SELECT ARSCHEDULEHEADER_ID, SUM(AMOUNT) AS AMOUNT_DUE FROM ARTRANSACTIONS
				WHERE ARSCHEDULEHEADER_ID IN (SELECT DISTINCT ARSCHEDULEHEADER_ID FROM ARSCHEDULEDETAIL WHERE DATEDUE = '20180301')
					AND DATESTAMP <= '20180301 4:00' --We think auto-charge completed before 4:00 AM.
				GROUP BY ARSCHEDULEHEADER_ID
			) AS T ON S.ARSCHEDULEHEADER_ID = T.ARSCHEDULEHEADER_ID
		WHERE S.AMOUNT_FUTURE < ISNULL(T.AMOUNT_DUE, 0)
		UNION SELECT ARSCHEDULEHEADER_ID FROM ARSCHEDULEHEADER WHERE ARSCHEDULEHEADER_ID IN (11599, 11744, 11918) --Schedules that finish on target date (@date).
	)
order by c.CUSTOMER_ID, ah.ARSCHEDULEHEADER_ID

